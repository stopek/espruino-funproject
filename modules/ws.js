var strChr=String.fromCharCode;function buildKey(){var a=btoa(Math.random().toString(36).substr(2,8)+Math.random().toString(36).substr(2,8));return{source:a,hashed:btoa(require("crypto").SHA1(a+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"))}}function WebSocket(b,a){this.socket=null,a=a||{},this.host=b,this.port=a.port||80,this.protocolVersion=a.protocolVersion||13,this.origin=a.origin||"Espruino",this.keepAlive=1e3*a.keepAlive||6e4,this.masking=void 0===a.masking||a.masking,this.path=a.path||"/",this.protocol=a.protocol,this.lastData="",this.key=buildKey(),this.connected=a.connected||!1,this.headers=a.headers||{}}WebSocket.prototype.initializeConnection=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))},WebSocket.prototype.onConnect=function(a){this.socket=a;var b=this;a.on("data",this.parseData.bind(this)),a.on("close",function(){b.pingTimer&&(clearInterval(b.pingTimer),b.pingTimer=void 0),b.emit("close")}),this.handshake()},WebSocket.prototype.parseData=function(a){var i=this;if(this.emit("rawData",a),this.lastData.length&&(a=this.lastData+a,this.lastData=""),!this.connected){a.indexOf(this.key.hashed)> -1&&a.indexOf("\r\n\r\n")> -1&&(this.emit("handshake"),this.pingTimer=setInterval(function(){i.send("ping",137)},this.keepAlive),a=a.substring(a.indexOf("\r\n\r\n")+4),this.connected=!0,this.emit("open")),this.lastData=a;return}for(;a.length;){var b=2,e=15&a.charCodeAt(0),c=127&a.charCodeAt(1);if(126==c)c=a.charCodeAt(3)|a.charCodeAt(2)<<8,b+=2;else if(127==c)throw"Messages >65535 in length unsupported";var f=c+b+(128&a.charCodeAt(1)?4:0);if(f>a.length){this.lastData=a;return}switch(e){case 10:this.emit("pong");break;case 9:this.send("pong",138),this.emit("ping");break;case 8:this.socket.end();break;case 0:case 1:var g=[0,0,0,0];128&a.charCodeAt(1)&&(g=[a.charCodeAt(b++),a.charCodeAt(b++),a.charCodeAt(b++),a.charCodeAt(b++)]);for(var h="",d=0;d<c;d++)h+=String.fromCharCode(a.charCodeAt(b++)^g[3&d]);this.emit("message",h);break;default:console.log("WS: Unknown opcode "+e)}a=a.substr(f)}},WebSocket.prototype.handshake=function(){var a=["GET "+this.path+" HTTP/1.1","Host: "+this.host,"Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: "+this.key.source,"Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin];for(var b in this.protocol&&a.push("Sec-WebSocket-Protocol: "+this.protocol),this.headers)this.headers.hasOwnProperty(b)&&a.push(b+": "+this.headers[b]);this.socket.write(a.join("\r\n")+"\r\n\r\n")},WebSocket.prototype.send=function(b,c){c=void 0===c?129:c;var d=b.length;if(b.length>125&&(d=126),this.socket.write(strChr(c,d+(this.masking?128:0))),126==d&&(this.socket.write(strChr(b.length>>8)),this.socket.write(strChr(b.length))),this.masking){for(var f=[],e="",a=0;a<4;a++){var g=Math.floor(255*Math.random());f[a]=g,e+=strChr(g)}for(var a=0;a<b.length;a++)e+=strChr(b.charCodeAt(a)^f[3&a]);this.socket.write(e)}else this.socket.write(b)},WebSocket.prototype.close=function(){this.socket.end()},(exports=function(b,c){var a=new WebSocket(b,c);return a.initializeConnection(),a}).createServer=function(b){var a=require("http").createServer(function(c,e){if(c.headers.Connection&&c.headers.Connection.indexOf("Upgrade")>=0){var g=c.headers["Sec-WebSocket-Key"],f={Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":btoa(E.toString(require("crypto").SHA1(g+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11")))};c.headers["Sec-WebSocket-Protocol"]&&(f["Sec-WebSocket-Protocol"]=c.headers["Sec-WebSocket-Protocol"]),e.writeHead(101,f);var d=new WebSocket(void 0,{masking:!1,connected:!0});d.socket=e,c.on("data",d.parseData.bind(d)),c.on("close",function(){clearInterval(d.srvPing),d.srvPing=void 0,d.emit("close")}),d.srvPing=setInterval(function(){d.emit("ping",!0),d.send("ping",137)},d.keepAlive),a.emit("websocket",d)}else b(c,e)});return a}